stages:
  - build
  - deploy

build_and_push_image:
  stage: build
  tags:
    - chigisoft
    - shared
  before_script:
    - export PREVIOUS_IMAGE_TAG="${CI_PROJECT_PATH}:$(echo $CI_COMMIT_BEFORE_SHA | cut -c -8)"
    - export PREVIOUS_CONTAINER_IMAGE_TAG="${REGISTRY_URL}/${PREVIOUS_IMAGE_TAG}"
    - export IMAGE_TAG="${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}"
    - export CONTAINER_IMAGE_TAG="${REGISTRY_URL}/${IMAGE_TAG}"
  script:
    - echo $REGISTRY_USER
    - echo "$REGISTRY_PASSWORD" | docker login --username "$REGISTRY_USER" --password-stdin "$REGISTRY_URL"
    - docker build -t ${CONTAINER_IMAGE_TAG} .
    - docker push ${CONTAINER_IMAGE_TAG}
    - docker rmi ${PREVIOUS_CONTAINER_IMAGE_TAG} || echo "no previous image available"

deploy_staging:
  stage: deploy
  tags:
    - chigisoft
    - shared
  only:
    - master
  before_script:
    - export IMAGE_TAG="${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}"
    - export CONTAINER_IMAGE_TAG="${REGISTRY_URL}/${IMAGE_TAG}"
  script:
    - sed -i "s%<ENVIRONMENT>%staging%g" deployment.yaml
    - sed -i "s%<IMAGE>%${CONTAINER_IMAGE_TAG}%g" deployment.yaml
    - kubectl apply -f deployment.yaml

deploy_production:
  stage: deploy
  tags:
    - chigisoft
    - shared
  only:
    - production
  before_script:
    - export IMAGE_TAG="${CI_PROJECT_PATH}:${CI_COMMIT_SHORT_SHA}"
    - export CONTAINER_IMAGE_TAG="${REGISTRY_URL}/${IMAGE_TAG}"
  script:
    - sed -i "s%<ENVIRONMENT>%production%g" deployment.yaml
    - sed -i "s%<IMAGE>%${CONTAINER_IMAGE_TAG}%g" deployment.yaml
    - kubectl apply -f deployment.yaml
